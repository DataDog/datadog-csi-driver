---
image: registry.ddbuild.io/images/mirror/golang:1.23.4
variables:
  PROJECTNAME: "datadog-csi-driver"
  BUILD_DOCKER_REGISTRY: "registry.ddbuild.io/ci"
  JOB_DOCKER_IMAGE: "registry.ddbuild.io/ci-containers-project:v50051243-ace27e7-v1.22"
cache: &global_cache
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - /go/pkg/mod

stages:
  - test
  - build_image

tests:
  stage: test
  image: registry.ddbuild.io/images/mirror/golang:1.23.4
  tags: ["arch:amd64"]
  script:
    - make test

build_image:
  stage: build_image
  tags:
    - "arch:amd64"
  image: $JOB_DOCKER_IMAGE
  variables:
    TARGET_IMAGE: $BUILD_DOCKER_REGISTRY/$PROJECTNAME:v${CI_PIPELINE_ID}-${CI_COMMIT_SHORT_SHA}
    RELEASE_IMAGE: $BUILD_DOCKER_REGISTRY/$PROJECTNAME:$CI_COMMIT_TAG
  script:
    - IMG=$TARGET_IMAGE make docker-buildx-ci
