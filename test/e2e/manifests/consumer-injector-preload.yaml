apiVersion: v1
kind: Pod
metadata:
  name: consumer-injector-preload
spec:
  containers:
  - name: consumer-injector-preload
    image: busybox
    command: ["/bin/sh", "-c"]
    args:
      - |
        set -e

        # Verify the preload file is mounted and contains the expected content
        test -f /etc/ld.so.preload
        test "$(cat /etc/ld.so.preload)" = "/opt/datadog-packages/datadog-apm-inject/stable/inject/launcher.preload.so"

        echo "Injector preload test passed"

        sleep 3600
    volumeMounts:
    - name: dd-preload-volume
      mountPath: /etc/ld.so.preload
      readOnly: true
  volumes:
  - name: dd-preload-volume
    csi:
      driver: k8s.csi.datadoghq.com
      readOnly: true
      volumeAttributes:
        type: DatadogInjectorPreload

